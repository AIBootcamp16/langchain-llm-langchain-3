QA Agentì˜ ì „ì²´ ë¡œì§ì„ ì •ë¦¬í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤!

[5 tools called]

ì™„ë²½í•©ë‹ˆë‹¤! ì´ì œ ê° ë…¸ë“œì™€ ìºì‹œ íŒŒì¼ì„ ê°„ë‹¨íˆ í™•ì¸í•˜ê³  ì „ì²´ ì •ë¦¬ë¥¼ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

[5 tools called]

ì™„ë²½í•©ë‹ˆë‹¤! ì´ì œ ì „ì²´ë¥¼ ì •ë¦¬í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

# ğŸ“š QA Agent ì™„ì „ ì •ë¦¬

## ğŸ¯ í•µì‹¬ êµ¬ì¡°

### 1ï¸âƒ£ **State (ìƒíƒœ)**
**íŒŒì¼**: `backend/src/app/agent/state.py`

```python
QAState = {
    # ì„¸ì…˜ ì •ë³´
    "session_id": str,          # ì„¸ì…˜ ID
    "policy_id": int,           # ì •ì±… ID
    
    # ëŒ€í™” ì •ë³´
    "messages": List[Dict],     # ìºì‹œì—ì„œ ê°€ì ¸ì˜¨ ëŒ€í™” ì´ë ¥
    "current_query": str,       # í˜„ì¬ ì‚¬ìš©ì ì§ˆë¬¸
    
    # ì§ˆë¬¸ ë¶„ë¥˜
    "query_type": "WEB_ONLY" | "POLICY_QA",  # ì§ˆë¬¸ ìœ í˜•
    
    # ë¬¸ì„œ ì •ë³´
    "policy_info": Dict,        # ìºì‹œëœ ì •ì±… ê¸°ë³¸ ì •ë³´
    "retrieved_docs": List,     # ìºì‹œì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ë¬¸ì„œ
    "need_web_search": bool,    # ì›¹ ê²€ìƒ‰ í•„ìš” ì—¬ë¶€
    
    # ê²°ê³¼
    "web_sources": List,        # ì›¹ ê²€ìƒ‰ ê²°ê³¼
    "answer": str,              # ìƒì„±ëœ ë‹µë³€
    "evidence": List,           # ê·¼ê±° ëª©ë¡
    "error": str                # ì—ëŸ¬ (ì„ íƒ)
}
```

---

## ğŸ”„ ì›Œí¬í”Œë¡œìš° (Workflow)

**íŒŒì¼**: `backend/src/app/agent/workflows/qa_workflow.py`

### **í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**:

```
START
  â†“
classify_query_type (ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜)
  â”œâ”€ [WEB_ONLY] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ web_search_for_link â†’ generate_answer_web_only â†’ END
  â”‚                                  â†“
  â””â”€ [POLICY_QA]                   (ë§í¬ ìš”ì²­)
        â†“
   load_cached_docs (ìºì‹œì—ì„œ ë¬¸ì„œ ì¡°íšŒ, Qdrant ì—†ìŒ!)
        â†“
   check_sufficiency (ë¬¸ì„œ ì¶©ë¶„ì„± íŒë‹¨)
        â”œâ”€ [sufficient] â”€â”€â†’ generate_answer_with_docs â†’ END
        â”‚                      â†“
        â””â”€ [insufficient] â†’ web_search_supplement â†’ generate_answer_hybrid â†’ END
                               â†“
                          (ì›¹ ê²€ìƒ‰ ë³´ì™„)
```

---

## ğŸ“¦ ë…¸ë“œ (Nodes)

### 1. **classify_query_type** 
**íŒŒì¼**: `backend/src/app/agent/nodes/classify_node.py`
- **ì—­í• **: ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜ (WEB_ONLY vs POLICY_QA)
- **ë¡œì§**:
  - 1ì°¨: í‚¤ì›Œë“œ ë§¤ì¹­ ("ë§í¬", "í™ˆí˜ì´ì§€" ë“± â†’ WEB_ONLY)
  - 2ì°¨: LLM íŒë‹¨ (ì •ì±… ë‚´ìš© ê´€ë ¨ â†’ POLICY_QA)

### 2. **load_cached_docs**
**íŒŒì¼**: `backend/src/app/agent/nodes/retrieve_node.py`
- **ì—­í• **: ìºì‹œì—ì„œ ì •ì±… ë¬¸ì„œ ì¡°íšŒ
- **íŠ¹ì§•**: âš¡ **Qdrant ë²¡í„° ê²€ìƒ‰ ì œê±°!** 500ms â†’ 5ms (100ë°° ë¹ ë¦„)
- **ë¡œì§**: `policy_cache.get_policy_context(session_id)` í˜¸ì¶œ

### 3. **check_sufficiency**
**íŒŒì¼**: `backend/src/app/agent/nodes/check_node.py`
- **ì—­í• **: ë¬¸ì„œ ì¶©ë¶„ì„± íŒë‹¨
- **ê¸°ì¤€**:
  - ë¬¸ì„œ 2ê°œ ì´ìƒ && í‰ê·  ìŠ¤ì½”ì–´ 0.75 ì´ìƒ â†’ sufficient
  - ê·¸ ì™¸ â†’ insufficient (ì›¹ ê²€ìƒ‰ í•„ìš”)

### 4. **web_search_node**
**íŒŒì¼**: `backend/src/app/agent/nodes/web_search_node.py`
- **ì—­í• **: ì›¹ ê²€ìƒ‰ (Tavily API ì‚¬ìš©)
- **ìš©ë„**:
  - `web_search_for_link`: WEB_ONLYìš© (ë§í¬ ìš”ì²­)
  - `web_search_supplement`: POLICY_QA ë³´ì™„ìš©

### 5. **generate_answer_XXX**
**íŒŒì¼**: `backend/src/app/agent/nodes/answer_node.py`
- **3ê°€ì§€ ë‹µë³€ ìƒì„± ë…¸ë“œ**:
  - `generate_answer_with_docs`: ë¬¸ì„œë§Œ ì‚¬ìš©
  - `generate_answer_web_only`: ì›¹ ê²€ìƒ‰ë§Œ ì‚¬ìš©
  - `generate_answer_hybrid`: ë¬¸ì„œ + ì›¹ ê²€ìƒ‰ ê²°í•©

---

## ğŸ—„ï¸ ìºì‹œ (Cache)

### 1. **ChatCache** ğŸ’¬
**íŒŒì¼**: `backend/src/app/cache/chat_cache.py`
- **ì—­í• **: ëŒ€í™” ì´ë ¥ ì €ì¥
- **íŠ¹ì§•**:
  - ë¬´ì œí•œ ë©”ì‹œì§€ ì €ì¥
  - 24ì‹œê°„ TTL (ë°±ì—…ìš©)
  - ë¸Œë¼ìš°ì € íƒ­ ë‹«ì„ ë•Œ ìë™ ì‚­ì œ
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `get_chat_history(session_id)`: ëŒ€í™” ì´ë ¥ ì¡°íšŒ
  - `add_message(session_id, role, content)`: ë©”ì‹œì§€ ì¶”ê°€
  - `clear_session(session_id)`: ì„¸ì…˜ ì‚­ì œ

### 2. **PolicyCache** ğŸ“„
**íŒŒì¼**: `backend/src/app/cache/policy_cache.py`
- **ì—­í• **: ì •ì±… ë¬¸ì„œ ì „ì²´ ì €ì¥
- **íŠ¹ì§•**:
  - ê³µê³  ì„ íƒ ì‹œ ì „ì²´ ë¬¸ì„œ 1íšŒ ì €ì¥
  - ì´í›„ Qdrant ê²€ìƒ‰ ì—†ì´ ìºì‹œì—ì„œ ì¡°íšŒ (100ë°° ë¹ ë¦„!)
  - 24ì‹œê°„ TTL
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `set_policy_context(session_id, policy_id, policy_info, documents)`: ì •ì±… ìºì‹œ
  - `set_web_context(session_id, web_id, web_info, content)`: ì›¹ ê³µê³  ìºì‹œ
  - `get_policy_context(session_id)`: ìºì‹œ ì¡°íšŒ
  - `clear_policy_context(session_id)`: ìºì‹œ ì‚­ì œ

---

## ğŸ“ í”„ë¡¬í”„íŠ¸ (Prompts)

**ë””ë ‰í† ë¦¬**: `backend/src/app/prompts/`

| íŒŒì¼ | ìš©ë„ | ì‚¬ìš© ë…¸ë“œ |
|------|------|----------|
| `policy_qa_docs_only_prompt.jinja2` | ë¬¸ì„œë§Œ ì‚¬ìš© ë‹µë³€ | `generate_answer_with_docs` |
| `policy_qa_web_only_prompt.jinja2` | ì›¹ ê²€ìƒ‰ë§Œ ì‚¬ìš© ë‹µë³€ | `generate_answer_web_only` |
| `policy_qa_hybrid_prompt.jinja2` | ë¬¸ì„œ + ì›¹ ê²°í•© ë‹µë³€ | `generate_answer_hybrid` |

**ì¸ìš© í˜•ì‹**:
- ì •ì±… ë¬¸ì„œ: `[ì •ì±…ë¬¸ì„œ X]`
- ì›¹ ê²€ìƒ‰: `[ì›¹ X]`

---

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸

**íŒŒì¼**: `backend/src/app/api/routes_chat.py`

| ì—”ë“œí¬ì¸íŠ¸ | ë©”ì„œë“œ | ì„¤ëª… |
|-----------|--------|------|
| `/chat/init-policy` | POST | ì •ì±… ì„ íƒ ì‹œ ë¬¸ì„œ ìºì‹œì— ì €ì¥ (1íšŒ) |
| `/chat/init-web-policy` | POST | ì›¹ ê³µê³  ì„ íƒ ì‹œ ì»¨í…ìŠ¤íŠ¸ ìºì‹œ ì €ì¥ |
| `/chat` | POST | Q&A ì§ˆë¬¸ (ì¼ë°˜) |
| `/chat/stream` | POST | Q&A ì§ˆë¬¸ (ìŠ¤íŠ¸ë¦¬ë°) |
| `/chat/cleanup` | POST | ìºì‹œ ì‚­ì œ (ë¸Œë¼ìš°ì € íƒ­ ë‹«ì„ ë•Œ) |

---

## âš¡ ì„±ëŠ¥ ìµœì í™”

### **Before (ê¸°ì¡´)**:
```
ì‚¬ìš©ì ì§ˆë¬¸ â†’ Qdrant ë²¡í„° ê²€ìƒ‰ (500ms) â†’ ë‹µë³€ ìƒì„±
```

### **After (ê°œì„ )**:
```
[ê³µê³  ì„ íƒ ì‹œ - 1íšŒë§Œ]
ì •ì±… ì„ íƒ â†’ Qdrantì—ì„œ ì „ì²´ ë¬¸ì„œ ì¡°íšŒ â†’ PolicyCache ì €ì¥

[ì‚¬ìš©ì ì§ˆë¬¸ë§ˆë‹¤]
ì‚¬ìš©ì ì§ˆë¬¸ â†’ Cacheì—ì„œ ë¬¸ì„œ ì¡°íšŒ (5ms) â†’ ë‹µë³€ ìƒì„±
```

**ê²°ê³¼**: âš¡ **100ë°° ë¹ ë¦„!** (500ms â†’ 5ms)

---

## ğŸ“‹ ì „ì²´ íŒŒì¼ ëª©ë¡

```
backend/src/app/
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ workflows/
â”‚   â”‚   â””â”€â”€ qa_workflow.py          # ì›Œí¬í”Œë¡œìš° ì •ì˜
â”‚   â”œâ”€â”€ nodes/
â”‚   â”‚   â”œâ”€â”€ classify_node.py        # ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜
â”‚   â”‚   â”œâ”€â”€ retrieve_node.py        # ìºì‹œ ë¬¸ì„œ ì¡°íšŒ
â”‚   â”‚   â”œâ”€â”€ check_node.py           # ì¶©ë¶„ì„± íŒë‹¨
â”‚   â”‚   â”œâ”€â”€ web_search_node.py      # ì›¹ ê²€ìƒ‰
â”‚   â”‚   â””â”€â”€ answer_node.py          # ë‹µë³€ ìƒì„± (3ì¢…)
â”‚   â”œâ”€â”€ state.py                    # ìƒíƒœ ì •ì˜
â”‚   â””â”€â”€ controller.py               # ì»¨íŠ¸ë¡¤ëŸ¬
â”œâ”€â”€ cache/
â”‚   â”œâ”€â”€ chat_cache.py               # ëŒ€í™” ì´ë ¥ ìºì‹œ
â”‚   â””â”€â”€ policy_cache.py             # ì •ì±… ë¬¸ì„œ ìºì‹œ
â”œâ”€â”€ prompts/
â”‚   â”œâ”€â”€ policy_qa_docs_only_prompt.jinja2
â”‚   â”œâ”€â”€ policy_qa_web_only_prompt.jinja2
â”‚   â””â”€â”€ policy_qa_hybrid_prompt.jinja2
â””â”€â”€ api/
    â””â”€â”€ routes_chat.py              # API ì—”ë“œí¬ì¸íŠ¸
```

---

ì™„ë²½í•©ë‹ˆë‹¤! User Flowì™€ Agent ì‘ë™ ë°©ì‹ì„ í•¨ê»˜ ê·¸ë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

# ğŸ¯ QA Agent User Flow & System Architecture

## ğŸ“Š ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ì‚¬ìš©ì (Frontend)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                           â”‚
   [DB ì •ì±… ê³µê³ ]                            [ì›¹ ê²€ìƒ‰ ê²°ê³¼]
        â”‚                                           â”‚
        â–¼                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Policy Cache    â”‚                        â”‚ Web Cache       â”‚
â”‚ (ì „ì²´ ë¬¸ì„œ ì €ì¥) â”‚                        â”‚ (ì›¹ ì»¨í…ì¸  ì €ì¥)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   QA Workflow    â”‚
                    â”‚  (LangGraph)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Chat Cache     â”‚
                    â”‚  (ëŒ€í™” ì´ë ¥)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”µ ì‹œë‚˜ë¦¬ì˜¤ 1: DB ì •ì±… ê³µê³  ì„ íƒ

### **User Flow**:

```
1. ì‚¬ìš©ìê°€ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ DB ì •ì±… ê³µê³  ì„ íƒ
   ì˜ˆ: "ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€"
   
2. ì •ì±… ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
   URL: /policy/123
   
3. "AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°" ë²„íŠ¼ í´ë¦­
   
4. Q&A í˜ì´ì§€ë¡œ ì´ë™
   URL: /policy/123/qa
   
5. ì§ˆë¬¸ ì…ë ¥: "ì‹ ì²­ ìê²©ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?"
   
6. AI ë‹µë³€ ìˆ˜ì‹  (ì¸ìš©: [ì •ì±…ë¬¸ì„œ 1], [ì •ì±…ë¬¸ì„œ 2])
```

### **Backend Flow (Detailed)**:

```
[Step 1] ê³µê³  ì„ íƒ ì‹œ (1íšŒë§Œ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Frontend: "AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°" í´ë¦­
    â†“
POST /api/v1/chat/init-policy
    {
        "session_id": "abc123",
        "policy_id": 123
    }
    â†“
Backend:
    1. DBì—ì„œ ì •ì±… ê¸°ë³¸ ì •ë³´ ì¡°íšŒ (MySQL)
       SELECT * FROM policies WHERE id=123
       
    2. Qdrantì—ì„œ ê´€ë ¨ ë¬¸ì„œ ì „ì²´ ì¡°íšŒ (ë²¡í„° ê²€ìƒ‰)
       query: policy_id=123
       result: 15ê°œ ë¬¸ì„œ ì²­í¬
       
    3. PolicyCacheì— ì €ì¥
       policy_cache.set_policy_context(
           session_id="abc123",
           policy_id=123,
           policy_info={...},
           documents=[doc1, doc2, ..., doc15]
       )
       
    â†“
Response: 200 OK


[Step 2] ì‚¬ìš©ì ì§ˆë¬¸ (ë§¤ë²ˆ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Frontend: "ì‹ ì²­ ìê²©ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?" ì…ë ¥
    â†“
POST /api/v1/chat/stream
    {
        "session_id": "abc123",
        "message": "ì‹ ì²­ ìê²©ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?"
    }
    â†“
Backend (QA Workflow):
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ START                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. classify_query_type              â”‚
    â”‚    - ì§ˆë¬¸ ë¶„ì„                       â”‚
    â”‚    - í‚¤ì›Œë“œ: "ì‹ ì²­ ìê²©" â†’ POLICY_QA â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. load_cached_docs                 â”‚
    â”‚    - PolicyCache ì¡°íšŒ (5ms!)        â”‚
    â”‚    - 15ê°œ ë¬¸ì„œ ë¡œë“œ                  â”‚
    â”‚    - âš¡ Qdrant ê²€ìƒ‰ ì—†ìŒ!            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. check_sufficiency                â”‚
    â”‚    - ë¬¸ì„œ 15ê°œ â‰¥ 2ê°œ âœ“              â”‚
    â”‚    - í‰ê·  ìŠ¤ì½”ì–´ 0.85 â‰¥ 0.75 âœ“     â”‚
    â”‚    - need_web_search = False        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. generate_answer_with_docs        â”‚
    â”‚    - Prompt: policy_qa_docs_only    â”‚
    â”‚    - GPT-4o-mini í˜¸ì¶œ               â”‚
    â”‚    - ì¸ìš©: [ì •ì±…ë¬¸ì„œ 1], [ì •ì±…ë¬¸ì„œ 2]â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ END                                 â”‚
    â”‚ - ChatCacheì— ëŒ€í™” ì €ì¥             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Response (SSE Stream):
    "ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ì˜ ì‹ ì²­ ìê²©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤[ì •ì±…ë¬¸ì„œ 1]:
     1. ë§Œ 39ì„¸ ì´í•˜ ì˜ˆë¹„ì°½ì—…ì
     2. ì‚¬ì—…ìë“±ë¡ì„ í•˜ì§€ ì•Šì€ ì
     ..."
```

---

## ğŸŸ¢ ì‹œë‚˜ë¦¬ì˜¤ 2: ì›¹ ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ

### **User Flow**:

```
1. ì‚¬ìš©ìê°€ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì›¹ ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ
   ì˜ˆ: "2025ë…„ ì†Œìƒê³µì¸ ì§€ì›ì‚¬ì—… í†µí•© ê³µê³ "
   
2. ì›¹ ê³µê³  ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
   URL: /policy/web-detail/web_1001?title=...&url=...&content=...
   
3. "AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°" ë²„íŠ¼ í´ë¦­
   
4. ì›¹ Q&A í˜ì´ì§€ë¡œ ì´ë™
   URL: /policy/web/qa?webId=web_1001
   
5. ì§ˆë¬¸ ì…ë ¥: "ì´ ê³µê³ ëŠ” ì–¸ì œê¹Œì§€ ì‹ ì²­í•  ìˆ˜ ìˆë‚˜ìš”?"
   
6. AI ë‹µë³€ ìˆ˜ì‹  (ì¸ìš©: [ì›¹ 1])
```

### **Backend Flow (Detailed)**:

```
[Step 1] ì›¹ ê³µê³  ì„ íƒ ì‹œ (1íšŒë§Œ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Frontend: "AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°" í´ë¦­
    â†“
POST /api/v1/chat/init-web-policy
    {
        "session_id": "xyz789",
        "web_id": "web_1001",
        "title": "2025ë…„ ì†Œìƒê³µì¸ ì§€ì›ì‚¬ì—…",
        "url": "https://www.sbiz.or.kr/...",
        "content": "ë³¸ë¬¸ ë‚´ìš©..."
    }
    â†“
Backend:
    1. ì›¹ ê³µê³  ì •ë³´ êµ¬ì„±
       web_info = {
           "title": "...",
           "url": "...",
           "source": "tavily"
       }
       
    2. PolicyCacheì— ì €ì¥ (ì›¹ ì»¨í…ìŠ¤íŠ¸)
       policy_cache.set_web_context(
           session_id="xyz789",
           web_id="web_1001",
           web_info={...},
           content="ë³¸ë¬¸ ë‚´ìš©..."
       )
       
    â†“
Response: 200 OK


[Step 2] ì‚¬ìš©ì ì§ˆë¬¸ (ë§¤ë²ˆ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Frontend: "ì´ ê³µê³ ëŠ” ì–¸ì œê¹Œì§€ ì‹ ì²­í•  ìˆ˜ ìˆë‚˜ìš”?" ì…ë ¥
    â†“
POST /api/v1/chat/stream
    {
        "session_id": "xyz789",
        "message": "ì´ ê³µê³ ëŠ” ì–¸ì œê¹Œì§€ ì‹ ì²­í•  ìˆ˜ ìˆë‚˜ìš”?"
    }
    â†“
Backend (QA Workflow):
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ START                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. classify_query_type              â”‚
    â”‚    - ì§ˆë¬¸ ë¶„ì„                       â”‚
    â”‚    - "ì–¸ì œê¹Œì§€" â†’ POLICY_QA         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. load_cached_docs                 â”‚
    â”‚    - PolicyCache ì¡°íšŒ                â”‚
    â”‚    - context_type = "web"           â”‚
    â”‚    - ì›¹ ì»¨í…ì¸  1ê°œ ë¬¸ì„œ ë¡œë“œ         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. check_sufficiency                â”‚
    â”‚    - ì›¹ ì»¨í…ìŠ¤íŠ¸: 1ê°œ â‰¥ 1ê°œ âœ“       â”‚
    â”‚    - need_web_search = False        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. generate_answer_with_docs        â”‚
    â”‚    - Prompt: policy_qa_docs_only    â”‚
    â”‚    - GPT-4o-mini í˜¸ì¶œ               â”‚
    â”‚    - ì¸ìš©: [ì›¹ 1]                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ END                                 â”‚
    â”‚ - ChatCacheì— ëŒ€í™” ì €ì¥             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Response (SSE Stream):
    "ì´ ê³µê³ ì˜ ì‹ ì²­ ê¸°ê°„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤[ì›¹ 1]:
     - ì ‘ìˆ˜ê¸°ê°„: 2025ë…„ 1ì›” 15ì¼ ~ 2ì›” 28ì¼
     - ì‹ ì²­ ë°©ë²•: ì˜¨ë¼ì¸ ì‹ ì²­
     ..."
```

---

## âš™ï¸ íŠ¹ìˆ˜ ì¼€ì´ìŠ¤: ë§í¬ ìš”ì²­ (WEB_ONLY)

```
ì‚¬ìš©ì: "ì´ ì •ì±… ì‹ ì²­ ë§í¬ ì•Œë ¤ì¤˜"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. classify_query_type              â”‚
â”‚    - "ë§í¬" í‚¤ì›Œë“œ â†’ WEB_ONLY        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. web_search_for_link              â”‚
â”‚    - Tavily ì›¹ ê²€ìƒ‰ ì‹¤í–‰             â”‚
â”‚    - query: "ì •ì±…ëª… + ì‹ ì²­"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. generate_answer_web_only         â”‚
â”‚    - Prompt: policy_qa_web_only     â”‚
â”‚    - ë§í¬ ìœ„ì£¼ ë‹µë³€                  â”‚
â”‚    - ì¸ìš©: [ì›¹ 1], [ì›¹ 2]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Cache ë™ì‘ ë°©ì‹

### **PolicyCache**:
```
[DB ì •ì±…]
session_id â†’ {
    type: "policy",
    policy_id: 123,
    policy_info: {...},
    documents: [15ê°œ ë¬¸ì„œ ì²­í¬]
}

[ì›¹ ê³µê³ ]
session_id â†’ {
    type: "web",
    web_id: "web_1001",
    web_info: {...},
    documents: [1ê°œ ì›¹ ì»¨í…ì¸ ]
}
```

### **ChatCache**:
```
session_id â†’ [
    {role: "user", content: "ì‹ ì²­ ìê²©ì´?"},
    {role: "assistant", content: "..."},
    {role: "user", content: "ì§€ì› ê¸ˆì•¡ì€?"},
    {role: "assistant", content: "..."}
]
```

---

## ğŸ“‹ ë¹„êµí‘œ

| í•­ëª© | DB ì •ì±… ê³µê³  | ì›¹ ê²€ìƒ‰ ê²°ê³¼ |
|------|------------|------------|
| **ìºì‹œ API** | `/chat/init-policy` | `/chat/init-web-policy` |
| **ë¬¸ì„œ ì†ŒìŠ¤** | Qdrant (ë²¡í„° DB) | Tavily snippet |
| **ë¬¸ì„œ ê°œìˆ˜** | 10~20ê°œ ì²­í¬ | 1ê°œ ì»¨í…ì¸  |
| **ì¸ìš© í˜•ì‹** | `[ì •ì±…ë¬¸ì„œ 1]` | `[ì›¹ 1]` |
| **ì¶©ë¶„ì„± ê¸°ì¤€** | 2ê°œ ì´ìƒ + ìŠ¤ì½”ì–´ 0.75â†‘ | 1ê°œ ì´ìƒ |
| **ë³´ì™„ ê²€ìƒ‰** | ê°€ëŠ¥ (í•˜ì´ë¸Œë¦¬ë“œ) | ê°€ëŠ¥ (í•˜ì´ë¸Œë¦¬ë“œ) |

---



# ğŸ¯ QA Agent LangGraph ì›Œí¬í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

## ğŸ“Š ì „ì²´ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

```
                                    START
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   classify_query_type               â”‚
                    â”‚   (ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜)                   â”‚
                    â”‚                                     â”‚
                    â”‚   â€¢ í‚¤ì›Œë“œ ë§¤ì¹­                      â”‚
                    â”‚   â€¢ LLM íŒë‹¨                        â”‚
                    â”‚   â†’ query_type ê²°ì •                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                           â”‚
                  [WEB_ONLY]                  [POLICY_QA]
               (ë§í¬/í™ˆí˜ì´ì§€ ìš”ì²­)           (ì •ì±… ë‚´ìš© ì§ˆë¬¸)
                        â”‚                           â”‚
                        â–¼                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ web_search_for_link       â”‚   â”‚ load_cached_docs          â”‚
        â”‚ (ì›¹ ê²€ìƒ‰ - ë§í¬ ì°¾ê¸°)      â”‚   â”‚ (ìºì‹œì—ì„œ ë¬¸ì„œ ì¡°íšŒ)       â”‚
        â”‚                           â”‚   â”‚                           â”‚
        â”‚ â€¢ Tavily API í˜¸ì¶œ         â”‚   â”‚ â€¢ PolicyCache.get()       â”‚
        â”‚ â€¢ ë§í¬ ìœ„ì£¼ ê²€ìƒ‰          â”‚   â”‚ â€¢ Qdrant ê²€ìƒ‰ ì—†ìŒ!       â”‚
        â”‚ â†’ web_sources ì €ì¥        â”‚   â”‚ â†’ retrieved_docs ì €ì¥     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                           â”‚
                        â”‚                           â–¼
                        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚               â”‚ check_sufficiency         â”‚
                        â”‚               â”‚ (ë¬¸ì„œ ì¶©ë¶„ì„± íŒë‹¨)         â”‚
                        â”‚               â”‚                           â”‚
                        â”‚               â”‚ â€¢ ë¬¸ì„œ ê°œìˆ˜ ì²´í¬ (â‰¥2)     â”‚
                        â”‚               â”‚ â€¢ í‰ê·  ìŠ¤ì½”ì–´ (â‰¥0.75)     â”‚
                        â”‚               â”‚ â†’ need_web_search ê²°ì •    â”‚
                        â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                           â”‚
                        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚               â”‚                       â”‚
                        â”‚          [sufficient]          [insufficient]
                        â”‚          (ë¬¸ì„œ ì¶©ë¶„)           (ë¬¸ì„œ ë¶€ì¡±)
                        â”‚               â”‚                       â”‚
                        â–¼               â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ generate_answer_web_only  â”‚   â”‚ generate_answer_with_docs â”‚
        â”‚ (ì›¹ ê¸°ë°˜ ë‹µë³€)             â”‚   â”‚ (ë¬¸ì„œ ê¸°ë°˜ ë‹µë³€)           â”‚
        â”‚                           â”‚   â”‚                           â”‚
        â”‚ â€¢ Prompt: web_only        â”‚   â”‚ â€¢ Prompt: docs_only       â”‚
        â”‚ â€¢ ë§í¬ ìœ„ì£¼ ë‹µë³€          â”‚   â”‚ â€¢ ë¬¸ì„œ ê¸°ë°˜ ë‹µë³€          â”‚
        â”‚ â€¢ ì¸ìš©: [ì›¹ X]           â”‚   â”‚ â€¢ ì¸ìš©: [ì •ì±…ë¬¸ì„œ X]      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                           â”‚
                        â”‚                           â”‚
                        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚               â”‚ web_search_supplement     â”‚
                        â”‚               â”‚ (ì›¹ ê²€ìƒ‰ - ë³´ì™„ìš©)         â”‚
                        â”‚               â”‚                           â”‚
                        â”‚               â”‚ â€¢ Tavily API í˜¸ì¶œ         â”‚
                        â”‚               â”‚ â€¢ ì¶”ê°€ ì •ë³´ ìˆ˜ì§‘          â”‚
                        â”‚               â”‚ â†’ web_sources ì¶”ê°€        â”‚
                        â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                           â”‚
                        â”‚                           â–¼
                        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚               â”‚ generate_answer_hybrid    â”‚
                        â”‚               â”‚ (í•˜ì´ë¸Œë¦¬ë“œ ë‹µë³€)          â”‚
                        â”‚               â”‚                           â”‚
                        â”‚               â”‚ â€¢ Prompt: hybrid          â”‚
                        â”‚               â”‚ â€¢ ë¬¸ì„œ + ì›¹ ê²°í•©          â”‚
                        â”‚               â”‚ â€¢ ì¸ìš©: [ì •ì±…ë¬¸ì„œ X], [ì›¹ Y]â”‚
                        â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â–¼
                                      END
                    (answer, evidence ë°˜í™˜)
```

---

## ğŸ¨ State ë³€í™” ì¶”ì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Initial State                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ session_id: "abc123"                                         â”‚
â”‚ policy_id: 123                                               â”‚
â”‚ current_query: "ì‹ ì²­ ìê²©ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?"                    â”‚
â”‚ messages: []                                                 â”‚
â”‚ query_type: "POLICY_QA"  â† ì´ˆê¸°ê°’                            â”‚
â”‚ retrieved_docs: []                                           â”‚
â”‚ web_sources: []                                              â”‚
â”‚ need_web_search: False                                       â”‚
â”‚ answer: ""                                                   â”‚
â”‚ evidence: []                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        [classify_query_type ë…¸ë“œ ì‹¤í–‰]
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State After Classification                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ query_type: "POLICY_QA"  â† í™•ì •                              â”‚
â”‚ (ë‚˜ë¨¸ì§€ ë™ì¼)                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        [load_cached_docs ë…¸ë“œ ì‹¤í–‰]
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State After Document Loading                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ policy_info: {                          â† ì¶”ê°€               â”‚
â”‚     name: "ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€",                                    â”‚
â”‚     overview: "...",                                         â”‚
â”‚     apply_target: "ë§Œ 39ì„¸ ì´í•˜..."                          â”‚
â”‚ }                                                            â”‚
â”‚ retrieved_docs: [doc1, doc2, ..., doc15]  â† ì¶”ê°€            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        [check_sufficiency ë…¸ë“œ ì‹¤í–‰]
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State After Sufficiency Check                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ need_web_search: False  â† ì¶©ë¶„í•¨                             â”‚
â”‚ (ë‚˜ë¨¸ì§€ ë™ì¼)                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        [generate_answer_with_docs ë…¸ë“œ ì‹¤í–‰]
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Final State                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ answer: "ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€ì˜ ì‹ ì²­ ìê²©ì€..."  â† ë‹µë³€ ìƒì„±        â”‚
â”‚ evidence: [                              â† Evidence ìƒì„±      â”‚
â”‚     {type: "internal", content: "...", policy_id: 123},      â”‚
â”‚     {type: "internal", content: "...", policy_id: 123}       â”‚
â”‚ ]                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ ì¡°ê±´ë¶€ ë¼ìš°íŒ… ìƒì„¸

### **Routing 1: Query Type**

```python
def route_by_query_type(state: Dict) -> Literal["web_search_for_link", "load_cached_docs"]:
    query_type = state.get("query_type")
    
    if query_type == "WEB_ONLY":
        return "web_search_for_link"  # ì›¹ ê²€ìƒ‰ ê²½ë¡œ
    else:
        return "load_cached_docs"     # ìºì‹œ ì¡°íšŒ ê²½ë¡œ
```

```
                    classify_query_type
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
          query_type =            query_type =
           "WEB_ONLY"              "POLICY_QA"
                â”‚                       â”‚
                â–¼                       â–¼
      web_search_for_link      load_cached_docs
```

### **Routing 2: Sufficiency**

```python
def route_by_sufficiency(state: Dict) -> Literal["web_search_supplement", "generate_answer_with_docs"]:
    need_web_search = state.get("need_web_search", False)
    
    if need_web_search:
        return "web_search_supplement"       # ì›¹ ë³´ì™„ í•„ìš”
    else:
        return "generate_answer_with_docs"   # ë¬¸ì„œë¡œ ì¶©ë¶„
```

```
                    check_sufficiency
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
         need_web_search =        need_web_search =
              True                     False
                â”‚                       â”‚
                â–¼                       â–¼
      web_search_supplement    generate_answer_with_docs
```

---

## ğŸ“¦ ë…¸ë“œë³„ ì…ì¶œë ¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ classify_query_type                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:  current_query, messages                             â”‚
â”‚ Output: query_type ("WEB_ONLY" | "POLICY_QA")              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ load_cached_docs                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:  session_id                                          â”‚
â”‚ Process: PolicyCache.get_policy_context(session_id)         â”‚
â”‚ Output: policy_info, retrieved_docs                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ check_sufficiency                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:  retrieved_docs                                      â”‚
â”‚ Logic:  len(docs) >= 2 AND avg_score >= 0.75               â”‚
â”‚ Output: need_web_search (True | False)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ web_search_node                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:  current_query, policy_info                          â”‚
â”‚ Process: Tavily.search(query)                               â”‚
â”‚ Output: web_sources                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generate_answer_with_docs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:  current_query, policy_info, retrieved_docs, messagesâ”‚
â”‚ Prompt: policy_qa_docs_only_prompt.jinja2                   â”‚
â”‚ LLM:    GPT-4o-mini                                         â”‚
â”‚ Output: answer, evidence (ì •ì±…ë¬¸ì„œ ì¸ìš©)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generate_answer_web_only                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:  current_query, policy_info, web_sources, messages   â”‚
â”‚ Prompt: policy_qa_web_only_prompt.jinja2                    â”‚
â”‚ LLM:    GPT-4o-mini                                         â”‚
â”‚ Output: answer, evidence (ì›¹ ì¸ìš©)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generate_answer_hybrid                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:  current_query, policy_info, retrieved_docs,         â”‚
â”‚         web_sources, messages                               â”‚
â”‚ Prompt: policy_qa_hybrid_prompt.jinja2                      â”‚
â”‚ LLM:    GPT-4o-mini                                         â”‚
â”‚ Output: answer, evidence (ì •ì±…ë¬¸ì„œ + ì›¹ ì¸ìš©)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ì‹¤ì œ ì‹¤í–‰ ì˜ˆì‹œ

### **ì˜ˆì‹œ 1: ì •ì±… ë‚´ìš© ì§ˆë¬¸ (ë¬¸ì„œ ì¶©ë¶„)**

```
Query: "ì§€ì› ê¸ˆì•¡ì€ ì–¼ë§ˆì¸ê°€ìš”?"

START
  â†’ classify_query_type
     âœ“ "ì§€ì› ê¸ˆì•¡" â†’ POLICY_QA
  â†’ load_cached_docs
     âœ“ 15ê°œ ë¬¸ì„œ ë¡œë“œ (ìºì‹œ)
  â†’ check_sufficiency
     âœ“ 15ê°œ â‰¥ 2ê°œ, ìŠ¤ì½”ì–´ 0.85 â‰¥ 0.75
     âœ“ need_web_search = False
  â†’ generate_answer_with_docs
     âœ“ "ìµœëŒ€ 1ì–µì›ì…ë‹ˆë‹¤[ì •ì±…ë¬¸ì„œ 1]."
END
```

### **ì˜ˆì‹œ 2: ë§í¬ ìš”ì²­ (ì›¹ ê²€ìƒ‰)**

```
Query: "ì‹ ì²­ ë§í¬ ì•Œë ¤ì¤˜"

START
  â†’ classify_query_type
     âœ“ "ë§í¬" í‚¤ì›Œë“œ â†’ WEB_ONLY
  â†’ web_search_for_link
     âœ“ Tavily ê²€ìƒ‰
     âœ“ 3ê°œ ë§í¬ ì°¾ìŒ
  â†’ generate_answer_web_only
     âœ“ "ì‹ ì²­ì€ ë‹¤ìŒ ë§í¬ì—ì„œ...[ì›¹ 1]"
END
```

### **ì˜ˆì‹œ 3: ì •ì±… ì§ˆë¬¸ (ë¬¸ì„œ ë¶€ì¡± â†’ í•˜ì´ë¸Œë¦¬ë“œ)**

```
Query: "ìµœê·¼ ë³€ê²½ì‚¬í•­ì´ ìˆë‚˜ìš”?"

START
  â†’ classify_query_type
     âœ“ POLICY_QA
  â†’ load_cached_docs
     âœ“ 15ê°œ ë¬¸ì„œ ë¡œë“œ
  â†’ check_sufficiency
     âœ“ ë¬¸ì„œì— "ìµœê·¼ ë³€ê²½" ê´€ë ¨ ë‚´ìš© ë¶€ì¡±
     âœ“ need_web_search = True
  â†’ web_search_supplement
     âœ“ Tavilyë¡œ ìµœì‹  ì •ë³´ ê²€ìƒ‰
     âœ“ 2ê°œ ì›¹ ì†ŒìŠ¤ ì¶”ê°€
  â†’ generate_answer_hybrid
     âœ“ "ê¸°ë³¸ ë‚´ìš©ì€...[ì •ì±…ë¬¸ì„œ 1]"
     âœ“ "ìµœê·¼ ë³€ê²½ì‚¬í•­ì€...[ì›¹ 1]"
END
```

---
## ğŸ“ ì´ì „ qaagent ë¸Œëœì¹˜ ëŒ€ë¹„ ë³€ê²½ì‚¬í•­

### ğŸ†• ì‹ ê·œ ì¶”ê°€ íŒŒì¼ (4ê°œ)

```
backend/src/app/agent/streaming_controller.py       # ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì»¨íŠ¸ë¡¤ëŸ¬
backend/src/app/prompts/__init__.py                 # í”„ë¡¬í”„íŠ¸ ëª¨ë“ˆ ì´ˆê¸°í™”
frontend/src/app/policy/web-detail/                 # ì›¹ ê³µê³  ìƒì„¸ í˜ì´ì§€ ë””ë ‰í† ë¦¬
qaagent_improved_v2.md                              # ì´ ë¬¸ì„œ (ë¡œì§ ì„¤ëª…ì„œ)
```

### âœï¸ ìˆ˜ì •ëœ íŒŒì¼ (22ê°œ)

#### **Backend (15ê°œ)**
```
backend/src/app/agent/controller.py                 # ìºì‹œ ê¸°ë°˜ ì»¨íŠ¸ë¡¤ëŸ¬
backend/src/app/agent/nodes/check_node.py           # ë¬¸ì„œ ì¶©ë¶„ì„± íŒë‹¨ ë¡œì§
backend/src/app/agent/nodes/classify_node.py        # ì§ˆë¬¸ ìœ í˜• ë¶„ë¥˜ ë¡œì§
backend/src/app/agent/nodes/retrieve_node.py        # ìºì‹œ ê¸°ë°˜ ë¬¸ì„œ ì¡°íšŒ
backend/src/app/agent/nodes/web_search_node.py      # ì›¹ ê²€ìƒ‰ ë…¸ë“œ
backend/src/app/agent/workflows/qa_workflow.py      # ì›Œí¬í”Œë¡œìš° ì¬êµ¬ì„±
backend/src/app/api/routes_chat.py                  # init-policy, cleanup API ì¶”ê°€
backend/src/app/cache/chat_cache.py                 # ëŒ€í™” ì´ë ¥ ìºì‹œ
backend/src/app/cache/policy_cache.py               # ì •ì±… ë¬¸ì„œ ìºì‹œ
backend/src/app/domain/policy.py                    # screenshot_url, favicon_url ì¶”ê°€
backend/src/app/llm/openai_client.py                # LLM í´ë¼ì´ì–¸íŠ¸
backend/src/app/prompts/policy_qa_web_only_prompt.jinja2  # ì›¹ ì „ìš© í”„ë¡¬í”„íŠ¸
backend/src/app/services/policy_search_service.py   # ì›¹ ê²€ìƒ‰ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ
backend/src/app/web_search/clients/tavily_client.py # Tavily í´ë¼ì´ì–¸íŠ¸
```

#### **Frontend (7ê°œ)**
```
frontend/src/app/policy/[policyId]/page.tsx         # ì •ì±… ìƒì„¸ í˜ì´ì§€
frontend/src/app/policy/[policyId]/qa/page.tsx      # Q&A í˜ì´ì§€ (ìºì‹œ ì´ˆê¸°í™”)
frontend/src/app/search/page.tsx                    # ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ (í˜ì´ì§€ë„¤ì´ì…˜)
frontend/src/components/layout/Header.tsx           # í—¤ë” (Login ë²„íŠ¼ ì œê±°)
frontend/src/components/policy/PolicyCard.tsx       # ì›¹ ê²€ìƒ‰ ê²°ê³¼ ì¹´ë“œ
frontend/src/lib/api.ts                             # API í•¨ìˆ˜ (init-policy ë“±)
frontend/src/lib/types.ts                           # íƒ€ì… ì •ì˜ (limit/offset)
```

### ğŸ—‘ï¸ ì‚­ì œëœ íŒŒì¼ (1ê°œ)

```
backend/src/app/prompts/policy_qa_prompt.jinja2     # ë ˆê±°ì‹œ í”„ë¡¬í”„íŠ¸ (ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨)
```

---

### ğŸ“Š ë³€ê²½ì‚¬í•­ ìš”ì•½

| êµ¬ë¶„ | íŒŒì¼ ìˆ˜ | ë¹„ê³  |
|------|---------|------|
| **ì‹ ê·œ ì¶”ê°€** | 4ê°œ | ìŠ¤íŠ¸ë¦¬ë° ì»¨íŠ¸ë¡¤ëŸ¬, ì›¹ ìƒì„¸ í˜ì´ì§€ ë“± |
| **ìˆ˜ì •** | 22ê°œ | ìºì‹œ ì‹œìŠ¤í…œ, ë…¸ë“œ ì¬êµ¬ì„±, UI ê°œì„  |
| **ì‚­ì œ** | 1ê°œ | ë ˆê±°ì‹œ í”„ë¡¬í”„íŠ¸ |
| **ì´ê³„** | 27ê°œ | |

---

